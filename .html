<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Myth AI - High-Fidelity (Fixed)</title>
    <meta name="description"
        content="A high-fidelity prototype of an advanced AI chat application with powerful, secure, and scalable features.">
    <meta name="theme-color" content="#181818">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.2.12/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.1/purify.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.25);
            border-radius: 10px;
            border: 2px solid #1e1e1e;
        }

        pre {
            background-color: #1a1a1a;
            color: #d4d4d4;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            font-family: 'Fira Code', monospace;
            font-size: 0.875rem;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .copy-code-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #333;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 0.75rem;
        }

        pre:hover .copy-code-btn {
            opacity: 1;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes scaleUp {
            from {
                transform: scale(0.95);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease-out forwards;
        }

        .modal-content {
            animation: scaleUp 0.3s ease-out forwards;
        }

        @keyframes message-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-wrapper {
            animation: message-in 0.4s ease-out forwards;
        }
    </style>
</head>

<body class="bg-[#101010] text-gray-200 overflow-hidden">

    <div class="absolute top-0 left-0 w-full h-full z-0 overflow-hidden">
        <div
            class="absolute -top-1/2 -left-1/2 w-[200%] h-[200%] bg-gradient-to-br from-blue-900/30 via-sky-900/10 to-transparent animate-[spin_30s_linear_infinite]">
        </div>
    </div>

    <div id="app-wrapper" class="relative z-10 flex h-screen w-screen" style="display: none;"></div>
    <div id="login-container" class="relative z-10 flex items-center justify-center h-screen w-screen p-4"></div>
    <div id="modal-container"></div>
    <div id="toast-container" class="fixed top-6 right-6 z-[100] flex flex-col gap-2"></div>


    <template id="template-app-wrapper">
        <aside id="sidebar"
            class="bg-black/40 backdrop-blur-lg border-r border-white/10 w-72 flex-shrink-0 flex flex-col p-2 h-full">
            <div class="flex-shrink-0"><button id="new-chat-btn"
                    class="w-full text-left flex items-center gap-3 p-3 rounded-lg hover:bg-white/10 transition-colors duration-200"><svg
                        xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 5v14" />
                        <path d="M5 12h14" />
                    </svg> New Chat</button></div>
            <div id="chat-history-list" class="flex-grow overflow-y-auto my-4 space-y-1 pr-1"></div>
            <div class="flex-shrink-0 border-t border-white/10 pt-2 space-y-1">
                <button id="upgrade-btn"
                    class="w-full text-left flex items-center gap-3 p-3 rounded-lg hover:bg-blue-500/20 text-blue-400 transition-colors duration-200"><svg
                        xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m15 11-4 4-4-4" />
                        <path d="m15 5-4 4-4-4" />
                    </svg> Upgrade Plan</button>
                <div class="p-2">
                    <label for="model-switcher" class="text-xs text-gray-400 mb-1 block">Current Model</label>
                    <select id="model-switcher"
                        class="w-full bg-white/5 p-2 rounded-lg border border-white/20 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"></select>
                </div>
                <button id="logout-btn"
                    class="w-full text-left flex items-center gap-3 p-3 rounded-lg hover:bg-red-500/20 text-red-400 transition-colors duration-200"><svg
                        xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                        <polyline points="16 17 21 12 16 7" />
                        <line x1="21" x2="9" y1="12" y2="12" />
                    </svg> Logout</button>
            </div>
        </aside>
        <main class="flex-1 flex flex-col bg-[#181818]">
            <header class="flex-shrink-0 p-4 flex items-center justify-center border-b border-white/10">
                <h1 id="ai-model-name" class="text-xl font-semibold text-center">Myth AI</h1>
            </header>
            <div id="chat-window" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6"></div>
            <div class="flex-shrink-0 p-2 md:p-4 md:px-6 border-t border-white/10">
                <div class="max-w-3xl mx-auto">
                    <div id="stop-generating-container" class="text-center mb-2" style="display: none;">
                        <button id="stop-generating-btn"
                            class="bg-red-600/50 hover:bg-red-600/80 text-white font-semibold py-2 px-4 rounded-lg transition-colors flex items-center gap-2 mx-auto"><svg
                                xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                viewBox="0 0 16 16">
                                <rect width="10" height="10" x="3" y="3" rx="1" />
                            </svg> Stop Generating</button>
                    </div>
                    <div class="relative bg-[#2a2a2a] rounded-2xl shadow-lg">
                        <textarea id="user-input" placeholder="Message Myth AI..."
                            class="w-full bg-transparent p-4 pr-16 resize-none rounded-2xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow"
                            rows="1"></textarea>
                        <div class="absolute right-3 top-1/2 -translate-y-1/2 flex items-center">
                            <button id="send-btn"
                                class="p-2 rounded-full bg-blue-600 hover:bg-blue-500 transition-colors disabled:bg-gray-600 disabled:cursor-not-allowed"><svg
                                    xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <line x1="22" y1="2" x2="11" y2="13" />
                                    <polygon points="22 2 15 22 11 13 2 9 22 2" />
                                </svg></button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </template>

    <template id="template-login">
        <div class="w-full max-w-sm bg-black/40 backdrop-blur-lg border border-white/10 rounded-2xl p-8 shadow-2xl">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-white">Get Started</h2>
                <p class="text-gray-400">Login to continue</p>
            </div>
            <form id="email-login-form">
                <input type="text" id="username" value="testuser" placeholder="Username"
                    class="w-full p-3 bg-white/5 rounded-lg border border-white/20 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all mb-4"
                    required>
                <input type="password" id="password" value="testuser123" placeholder="Password"
                    class="w-full p-3 bg-white/5 rounded-lg border border-white/20 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all mb-4"
                    required>
                <button type="submit"
                    class="w-full bg-sky-600 hover:bg-sky-500 text-white font-bold py-3 px-4 rounded-lg transition-colors">Continue</button>
                <p id="login-error" class="text-red-400 text-sm text-center h-4 mt-2"></p>
            </form>
            <div class="text-center mt-4">
                <button id="admin-login-btn" class="text-xs text-gray-400 hover:text-white">Sign In as Admin</button>
            </div>
        </div>
    </template>

    <template id="template-welcome-screen">
        <div class="flex flex-col items-center justify-center h-full text-center p-4">
            <div
                class="w-16 h-16 bg-gradient-to-br from-blue-500 to-sky-600 rounded-full flex items-center justify-center text-3xl font-bold mb-4">
                M</div>
            <h2 class="text-2xl md:text-3xl font-bold mb-6">How can I help you today?</h2>
        </div>
    </template>

    <template id="template-upgrade-modal">
        <div class="modal-backdrop fixed inset-0"></div>
        <div
            class="modal-content w-full max-w-md bg-[#1e1e1e] rounded-2xl p-8 shadow-2xl relative border border-white/20">
            <button
                class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            <h3 class="text-2xl font-bold text-center mb-2">Upgrade Your Plan</h3>
            <p class="text-center text-gray-400 mb-6">Unlock more powerful models.</p>

            <div class="space-y-4 mb-6">
                <div class="bg-white/5 p-4 rounded-lg flex justify-between items-center gap-2">
                    <div>
                        <h4 class="font-semibold">Myth 1.5</h4>
                        <p class="text-sm text-gray-400">Based on Gemini 1.5 Flash.</p>
                    </div>
                    <button class="buy-model-btn bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg transition-colors"
                        data-model="gemini-1.5-flash-latest" data-price="4.99" data-name="Myth 1.5">$4.99</button>
                </div>
                <div class="bg-white/5 p-4 rounded-lg flex justify-between items-center gap-2">
                    <div>
                        <h4 class="font-semibold">MythPlus (Beta)</h4>
                        <p class="text-sm text-gray-400">Based on Gemini Pro.</p>
                    </div>
                    <button class="buy-model-btn bg-green-600 hover:bg-green-500 px-4 py-2 rounded-lg transition-colors"
                        data-model="gemini-pro" data-price="9.99" data-name="MythPlus (Beta)">$9.99</button>
                </div>
                <div class="bg-white/5 p-4 rounded-lg flex justify-between items-center gap-2">
                    <div>
                        <h4 class="font-semibold">MythUltra</h4>
                        <p class="text-sm text-gray-400">The latest and most capable model.</p>
                    </div>
                    <button
                        class="buy-model-btn bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded-lg transition-colors"
                        data-model="gemini-ultra" data-price="19.99" data-name="MythUltra">$19.99</button>
                </div>
            </div>
        </div>
    </template>

    <template id="template-payment-modal">
        <div class="modal-backdrop fixed inset-0"></div>
        <div
            class="modal-content w-full max-w-md bg-[#1e1e1e] rounded-2xl p-8 shadow-2xl relative border border-white/20">
            <button
                class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            <h3 class="text-2xl font-bold text-center mb-2">Complete Your Purchase</h3>
            <p class="text-center text-gray-400 mb-6">You are buying <span id="payment-model-name"
                    class="font-bold"></span> for $<span id="payment-model-price"></span>.</p>

            <form id="payment-form">
                <div class="space-y-4">
                    <input type="text" placeholder="Name on Card"
                        class="w-full p-3 bg-white/5 rounded-lg border border-white/20 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required>
                    <input type="text" placeholder="Card Number"
                        class="w-full p-3 bg-white/5 rounded-lg border border-white/20 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required>
                    <div class="flex gap-4">
                        <input type="text" placeholder="MM / YY"
                            class="w-1/2 p-3 bg-white/5 rounded-lg border border-white/20 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required>
                        <input type="text" placeholder="CVC"
                            class="w-1/2 p-3 bg-white/5 rounded-lg border border-white/20 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required>
                    </div>
                    <button type="submit" id="confirm-payment-btn"
                        class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded-lg transition-colors">Pay
                        Now</button>
                </div>
            </form>
        </div>
    </template>

    <template id="template-admin-dashboard">
        <div class="w-full h-full bg-[#101010] p-8 overflow-y-auto">
            <header class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold">Admin Dashboard</h1>
                <button id="admin-logout-btn"
                    class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">Logout</button>
            </header>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-black/40 p-6 rounded-lg border border-white/10">
                    <h2 class="text-gray-400 text-lg">Total Users</h2>
                    <p id="admin-total-users" class="text-4xl font-bold">0</p>
                </div>
                <div class="bg-black/40 p-6 rounded-lg border border-white/10">
                    <h2 class="text-gray-400 text-lg">Total API Calls</h2>
                    <p id="admin-total-calls" class="text-4xl font-bold">0</p>
                </div>
                <div class="bg-black/40 p-6 rounded-lg border border-white/10">
                    <h2 class="text-gray-400 text-lg">Users at Limit</h2>
                    <p id="admin-limit-users" class="text-4xl font-bold">0</p>
                </div>
            </div>
            <div class="mt-8 bg-black/40 p-6 rounded-lg border border-white/10">
                <h2 class="text-xl font-semibold mb-4">User Management</h2>
                <div id="admin-user-list" class="space-y-2"></div>
            </div>
        </div>
    </template>

    <script>
        /****************************************************************************
         * JAVASCRIPT FRONTEND LOGIC
         ****************************************************************************/
        document.addEventListener('DOMContentLoaded', () => {
            const appState = {
                chats: {},
                activeChatId: null,
                isAITyping: false,
                abortController: null,
                currentUser: null,
                getActiveModel: () => document.getElementById('model-switcher')?.value,
            };

            const DOMElements = {
                appWrapper: document.getElementById('app-wrapper'),
                loginContainer: document.getElementById('login-container'),
                modalContainer: document.getElementById('modal-container'),
                toastContainer: document.getElementById('toast-container'),
            };

            function showToast(message, type = 'info') {
                const colors = { info: 'bg-blue-600', success: 'bg-green-600', error: 'bg-red-600' };
                const toast = document.createElement('div');
                toast.className = `toast text-white text-sm py-2 px-4 rounded-lg shadow-lg ${colors[type]}`;
                toast.textContent = message;
                DOMElements.toastContainer.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }

            async function streamChat(history, model, onChunk, onError, onComplete, abortSignal) {
                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ history, model, username: appState.currentUser.username }),
                        signal: abortSignal,
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `Server error: ${response.status}`);
                    }
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        onChunk(decoder.decode(value));
                    }
                } catch (err) {
                    if (err.name !== 'AbortError') onError(err.message);
                } finally {
                    onComplete();
                }
            }

            function handleSendMessage() {
                const userInput = document.getElementById('user-input');
                const prompt = userInput.value.trim();
                if (!prompt || appState.isAITyping) return;

                if (!appState.activeChatId) {
                    createNewChat(false);
                }

                const chat = appState.chats[appState.activeChatId];
                const userMessage = { sender: 'user', content: prompt };
                chat.messages.push(userMessage);

                if (chat.title === 'New Chat') {
                    chat.title = prompt.substring(0, 30) + (prompt.length > 30 ? '...' : '');
                }

                document.getElementById('chat-window').querySelector('#template-welcome-screen')?.remove();
                addMessageToDOM(userMessage);
                userInput.value = '';
                userInput.style.height = 'auto';

                appState.isAITyping = true;
                appState.abortController = new AbortController();
                updateUIState();

                const aiMessage = { sender: 'ai', content: '', model: appState.getActiveModel() };
                chat.messages.push(aiMessage);
                const aiContentEl = addMessageToDOM(aiMessage, true).querySelector('.message-content');

                streamChat(
                    chat.messages.slice(0, -1),
                    appState.getActiveModel(),
                    (chunk) => {
                        aiMessage.content += chunk;
                        aiContentEl.innerHTML = DOMPurify.sanitize(marked.parse(aiMessage.content));
                        aiContentEl.parentElement.scrollIntoView({ behavior: 'smooth', block: 'end' });
                    },
                    (err) => {
                        aiMessage.content += `\\n\\n**Error:** ${err}`;
                        aiContentEl.innerHTML = DOMPurify.sanitize(marked.parse(aiMessage.content));
                        showToast(err, 'error');
                    },
                    () => {
                        appState.isAITyping = false;
                        appState.abortController = null;
                        updateUIState();
                        renderCodeCopyButtons();
                    },
                    appState.abortController.signal
                );
            }

            function createNewChat(shouldRender = true) {
                const newChatId = `chat_${Date.now()}`;
                appState.chats[newChatId] = { id: newChatId, title: 'New Chat', messages: [] };
                appState.activeChatId = newChatId;
                if (shouldRender) {
                    renderActiveChat();
                    renderChatHistoryList();
                }
                return newChatId;
            }

            function addMessageToDOM(msg, isStreaming = false) {
                const chatWindow = document.getElementById('chat-window');
                const wrapper = document.createElement('div');
                wrapper.className = 'message-wrapper';
                const avatarColor = msg.sender === 'ai' ? 'bg-gradient-to-br from-blue-500 to-sky-600' : appState.currentUser.avatarColor;
                const avatarChar = msg.sender === 'ai' ? 'M' : appState.currentUser.username[0].toUpperCase();

                wrapper.innerHTML = `
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full ${avatarColor} flex items-center justify-center font-bold text-sm">${avatarChar}</div>
                    <div class="flex-1 min-w-0">
                        <div class="font-bold text-gray-300">${msg.sender === 'ai' ? `Myth AI (${msg.model})` : 'You'}</div>
                        <div class="prose prose-invert max-w-none text-gray-200 message-content">
                            ${isStreaming ? '<span class="animate-pulse">...</span>' : DOMPurify.sanitize(marked.parse(msg.content))}
                        </div>
                    </div>
                </div>`;
                chatWindow.appendChild(wrapper);
                chatWindow.scrollTop = chatWindow.scrollHeight;
                return wrapper;
            }

            function renderActiveChat() {
                const chatWindow = document.getElementById('chat-window');
                chatWindow.innerHTML = '';
                const chat = appState.chats[appState.activeChatId];
                if (chat && chat.messages.length > 0) {
                    chat.messages.forEach(msg => addMessageToDOM(msg));
                    renderCodeCopyButtons();
                } else {
                    const welcomeTemplate = document.getElementById('template-welcome-screen');
                    chatWindow.appendChild(welcomeTemplate.content.cloneNode(true));
                }
                updateUIState();
            }

            function renderChatHistoryList() {
                const listEl = document.getElementById('chat-history-list');
                if (!listEl) return;
                listEl.innerHTML = '';
                Object.values(appState.chats).sort((a, b) => b.id.split('_')[1] - a.id.split('_')[1]).forEach(chat => {
                    const item = document.createElement('button');
                    item.className = `w-full text-left p-3 rounded-lg hover:bg-white/10 transition-colors duration-200 truncate ${chat.id === appState.activeChatId ? 'bg-white/10 font-semibold' : ''}`;
                    item.textContent = chat.title;
                    item.addEventListener('click', () => {
                        appState.activeChatId = chat.id;
                        renderActiveChat();
                        renderChatHistoryList();
                    });
                    listEl.appendChild(item);
                });
            }

            function updateUIState() {
                const sendBtn = document.getElementById('send-btn');
                const stopContainer = document.getElementById('stop-generating-container');
                const modelSwitcher = document.getElementById('model-switcher');
                const aiModelName = document.getElementById('ai-model-name');

                if (sendBtn) sendBtn.disabled = appState.isAITyping;
                if (stopContainer) stopContainer.style.display = appState.isAITyping ? 'block' : 'none';
                if (aiModelName) aiModelName.textContent = `Myth AI (${appState.getActiveModel()})`;

                if (modelSwitcher && appState.currentUser) {
                    const currentModels = Array.from(modelSwitcher.options).map(o => o.value);
                    if (JSON.stringify(currentModels) !== JSON.stringify(appState.currentUser.unlockedModels)) {
                        modelSwitcher.innerHTML = '';
                        appState.currentUser.unlockedModels.forEach(modelId => {
                            const option = new Option(modelId, modelId);
                            modelSwitcher.add(option);
                        });
                    }
                    modelSwitcher.value = appState.currentUser.activeModel;
                }
            }

            function renderCodeCopyButtons() {
                document.querySelectorAll('pre').forEach(pre => {
                    if (pre.querySelector('.copy-code-btn')) return;
                    const button = document.createElement('button');
                    button.className = 'copy-code-btn';
                    button.textContent = 'Copy';
                    button.onclick = () => {
                        navigator.clipboard.writeText(pre.querySelector('code')?.innerText || '').then(() => {
                            button.textContent = 'Copied!';
                            setTimeout(() => button.textContent = 'Copy', 2000);
                        });
                    };
                    pre.appendChild(button);
                });
            }

            function openModal(templateId, context = {}) {
                const template = document.getElementById(templateId);
                const modalWrapper = document.createElement('div');
                modalWrapper.id = `modal-${templateId}`;
                modalWrapper.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
                modalWrapper.appendChild(template.content.cloneNode(true));
                DOMElements.modalContainer.appendChild(modalWrapper);

                const closeModal = () => modalWrapper.remove();
                modalWrapper.querySelector('.close-modal-btn')?.addEventListener('click', closeModal);
                modalWrapper.querySelector('.modal-backdrop')?.addEventListener('click', closeModal);

                if (templateId === 'template-upgrade-modal') {
                    modalWrapper.querySelectorAll('.buy-model-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const modelData = e.target.dataset;
                            openModal('template-payment-modal', modelData);
                            closeModal(); // Close the upgrade modal
                        });
                    });
                }

                if (templateId === 'template-payment-modal') {
                    modalWrapper.querySelector('#payment-model-name').textContent = context.name;
                    modalWrapper.querySelector('#payment-model-price').textContent = context.price;
                    modalWrapper.querySelector('#payment-form').addEventListener('submit', (e) => {
                        e.preventDefault();
                        showToast(`Simulating payment for ${context.name}...`, 'info');

                        if (!appState.currentUser.unlockedModels.includes(context.model)) {
                            appState.currentUser.unlockedModels.push(context.model);
                            updateUIState();
                            showToast(`${context.name} unlocked!`, 'success');
                        } else {
                            showToast(`You already own ${context.name}.`, 'info');
                        }
                        setTimeout(closeModal, 1500);
                    });
                }
            }

            async function initializeApp(user) {
                appState.currentUser = user;
                DOMElements.loginContainer.style.display = 'none';

                if (user.role === 'admin') {
                    const adminTemplate = document.getElementById('template-admin-dashboard');
                    DOMElements.appWrapper.innerHTML = '';
                    DOMElements.appWrapper.appendChild(adminTemplate.content.cloneNode(true));
                    DOMElements.appWrapper.style.display = 'block';
                    document.getElementById('admin-logout-btn').addEventListener('click', handleLogout);

                    // Fetch and display admin data
                    const response = await fetch('/api/admin_data');
                    const data = await response.json();
                    document.getElementById('admin-total-users').textContent = data.total_users;
                    document.getElementById('admin-total-calls').textContent = data.total_calls;
                    document.getElementById('admin-limit-users').textContent = data.users_at_limit;
                    const userList = document.getElementById('admin-user-list');
                    userList.innerHTML = '';
                    for (const [username, usage] of Object.entries(data.user_usage)) {
                        const userDiv = document.createElement('div');
                        userDiv.className = 'p-2 bg-white/5 rounded-md flex justify-between items-center';
                        userDiv.innerHTML = `<span>${username}</span> <span class="text-gray-400">API Calls: ${usage} / 5</span>`;
                        userList.appendChild(userDiv);
                    }

                } else {
                    const appTemplate = document.getElementById('template-app-wrapper');
                    DOMElements.appWrapper.innerHTML = '';
                    DOMElements.appWrapper.appendChild(appTemplate.content.cloneNode(true));
                    DOMElements.appWrapper.style.display = 'flex';

                    renderActiveChat();
                    renderChatHistoryList();

                    const userInput = document.getElementById('user-input');
                    userInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); }
                    });
                    userInput.addEventListener('input', () => {
                        userInput.style.height = 'auto';
                        userInput.style.height = `${userInput.scrollHeight}px`;
                    });
                    document.getElementById('send-btn').addEventListener('click', handleSendMessage);
                    document.getElementById('new-chat-btn').addEventListener('click', () => createNewChat(true));
                    document.getElementById('stop-generating-btn').addEventListener('click', () => appState.abortController?.abort());
                    document.getElementById('upgrade-btn').addEventListener('click', () => openModal('template-upgrade-modal'));
                    document.getElementById('logout-btn').addEventListener('click', handleLogout);
                    document.getElementById('model-switcher').addEventListener('change', (e) => {
                        appState.currentUser.activeModel = e.target.value;
                        updateUIState();
                    });
                }
            }

            function handleLogout() {
                appState.currentUser = null;
                DOMElements.appWrapper.innerHTML = '';
                DOMElements.appWrapper.style.display = 'none';
                DOMElements.loginContainer.style.display = 'flex';
            }

            // --- Initial Load ---
            const loginTemplate = document.getElementById('template-login');
            DOMElements.loginContainer.innerHTML = '';
            DOMElements.loginContainer.appendChild(loginTemplate.content.cloneNode(true));
            DOMElements.loginContainer.querySelector('#email-login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = e.target.querySelector('#username').value;
                const password = e.target.querySelector('#password').value;

                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password }),
                });
                const data = await response.json();
                if (response.ok) {
                    initializeApp(data.user);
                } else {
                    document.getElementById('login-error').textContent = data.error;
                }
            });

            DOMElements.loginContainer.querySelector('#admin-login-btn').addEventListener('click', () => {
                document.getElementById('username').value = 'admin';
                document.getElementById('password').value = 'admin123';
                DOMElements.loginContainer.querySelector('form').requestSubmit();
            });
        });
    </script>
</body>

</html>